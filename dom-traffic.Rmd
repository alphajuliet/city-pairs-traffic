---
title: "City Pairs - Domestic Traffic"
author: "AndrewJ"
date: "4 June 2016"
output: pdf_document
---

# Description

Visualisation experimentation on some random data sets. In this case, it's an [monthly airport domestic traffic data](https://data.gov.au/dataset/domestic-airlines-top-routes-and-totals) via data.gov.au, dated 2016-05.

# Setup

```{r echo=FALSE, include=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggthemes)
library(treemap)
library(formattable)
library(circlize)
```

# Import

```{r}
read_traffic <- function () {
  read_csv("DOMCityPairsWeb.csv")
}
```

# Transform

```{r}
transform_traffic <- function (df) {
  df %>% 
  mutate(
    Month = as.Date(Month, origin="1899-12-30"),
    City1 = as.factor(City1),
    City2 = as.factor(City2))
}
```

# Analyse

See the total traffic by month
```{r}
monthly_traffic <- . %>%
  group_by(Month) %>%
  summarise(
    Trips = sum(Passenger_Trips),
    Seats = sum(Seats)) %>%
  mutate(
    Trips = rollmean(Trips, k = 12, fill = "extend", align = "center"),
    Seats = rollmean(Seats, k = 12, fill = "extend", align = "center"))
```

Get stats on source and destination airport pairs
```{r}
by_airport_pairs <- . %>%
  unite(Journey, City1, City2, sep = " â€” ", remove = TRUE) %>%
  group_by(Journey)
```

# Run

## Import the data.

```{r}
dom <- read_traffic() %>% transform_traffic()
str(dom)
levels(dom$City1)
```

## Do some plotting

Time series moving average
```{r}
dom %>%
  monthly_traffic() %>%
  gather(
    key = Type, value = Trips, 
    Trips, Seats) %>%
  ggplot(aes(x=Month, y=Trips, colour=Type)) +
    geom_line(stat = 'identity', position = "stack") +
    labs(title = "Passenger Trips and Seats (k=12)", x = "Month", y = "Number") +
    theme_fivethirtyeight()
```

Busiest routes
```{r}
dom %>%
  by_airport_pairs() %>%
  summarise(Trips = Passenger_Trips %>% mean %>% comma(digits=0)) %>%
  arrange(desc(Trips)) %>%
  head(n = 20) %>%
  ggplot(aes(x = reorder(Journey, Trips), y = Trips)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = Trips), size=3, hjust = -0.1, colour = "black") +
    coord_flip() +
    labs(title = "Top Passenger Trips", x = "Journey", y = "Passengers") +
    theme(axis.title.y = element_blank())

```

Longest journeys
```{r}
dom %>%
  by_airport_pairs() %>%
  summarise(
    Distance = mean(`Distance_GC_(km)`),
    Trips = mean(Passenger_Trips)) %>%
  arrange(desc(Distance)) %>%
  head(n = 20) %>%
  ggplot(aes(x = reorder(Journey, Distance), y = Distance)) +
  geom_bar(stat = "identity", aes(fill = Trips)) +
  coord_flip() +
  labs(title = "Longest flights", y = "Distance (km)", x = "Sector")
```

Chord diagram for top journeys
```{r}
dom %>%
  group_by(City1, City2) %>%
  summarise(Trips = sum(Passenger_Trips)) %>%
  ungroup() %>%
  arrange(desc(Trips)) %>%
  head(20) %>%
  chordDiagram()
circos.clear()
```

Play with some scatter plots
```{r}
dom %>%
  by_airport_pairs %>%
  summarise(
    Passengers = sum(Passenger_Trips), 
    Flights = sum(Aircraft_Trips),
    Load = mean(Passenger_Load_Factor),
    Distance = mean(`Distance_GC_(km)`)) %>%
  ggplot(aes(x = Passengers, y = Distance, colour = Load)) +
  geom_point()
```

The End