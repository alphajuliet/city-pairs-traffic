---
title: "R Notebook"
output: html_notebook
---

```{r}
rm(list=ls())
```


```{r results='hide'}
library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggthemes)
library(gridExtra)
library(ggrepel)
library(RColorBrewer)
library(formattable)
library(circlize)
```

```{r}
read_traffic <- function () {
  read_csv("data/audomcitypairs-20171004.csv")
}

transform_traffic <- function (df) {
  df %>% 
  mutate(
    Month = as.Date(Month, origin="1899-12-30"), # Convert from Excel format
    City1 = as.factor(City1),
    City2 = as.factor(City2))
}
```

## Analysis Functions

Aggregate traffic by months, and augment with moving averages using zoo::rollmean.

```{r}
monthly_traffic <- . %>%
  select(Month, Trips = Passenger_Trips, Seats, RPKs, ASKs) %>%
  group_by(Month) %>%
  summarise_all(funs(. %>% as.numeric %>% sum)) %>%
  # rename_all(funs(str_replace(., "_\\w+", ""))) %>%
  mutate_at(
    vars(Trips, Seats, RPKs, ASKs), 
    funs(rollmean(., k = 12, fill = "extend", align = "center")))
```

Group into a route name

```{r}
by_airport_pairs <- . %>%
  unite(Journey, City1, City2, sep = " â€” ", remove = TRUE) %>%
  group_by(Journey)
```

Pull out the busiest routes by passenger trips in a given year

```{r}
busiest_routes <- function (df, n = 20, year = 2016) { 
  df %>%
    filter(Year == year) %>%
    group_by(City1, City2) %>%
    summarise(
      Trips = Passenger_Trips %>% mean %>% floor) %>%
    arrange(desc(Trips)) %>%
    head(n = n)
}
```

# Run

```{r}
dom <- read_traffic() %>% transform_traffic()
glimpse(dom)
```

# Analysis

Linear regression

```{r}
lm_model <- lm(Passenger_Trips ~ Month, data = dom)
summary(lm_model)
```


# Visualisations

## Moving average and Loess fit

```{r}
dom %>%
  monthly_traffic() %>%
  ggplot(aes(x=Month, y = Trips)) +
  geom_line(
    colour = "red") +
  stat_smooth(
    method = "loess", colour = "#999999", size = 0.2) +
  scale_x_date(
    date_breaks = "4 years", 
    date_minor_breaks = "1 year", 
    date_labels = "%Y") +
  scale_y_continuous(
    limits = c(0, 5e6), 
    labels = scales::comma) +
  labs(
    title = "Passenger Trips", 
    x = "Year", 
    y = NULL) +
  theme_minimal()
```

## Busiest Routes

```{r}
dom %>%
  busiest_routes(year = 2016, n = 20) %>%
  by_airport_pairs %>%
  ggplot(aes(x = reorder(Journey, Trips), y = Trips)) +
  geom_bar(
    stat = "identity", 
    width = 0.5, 
    fill = "#990033") +
  geom_text(
    aes(label = prettyNum(Trips, big.mark = ",")), 
    size=2.5, hjust = -0.1, 
    colour = "#333333") +
  scale_y_continuous(
    limits = c(0, 800000),
    labels = scales::comma) +
  coord_flip() +
  labs(
    title = "Busiest routes in 2016", 
    x = "Journey", 
    y = "Passengers") +
  theme_minimal() +
  theme(axis.title.y = element_blank())
```

## Longest flights

```{r}
dom %>%
  filter(Year == 2016) %>%
  by_airport_pairs() %>%
  summarise(
    Distance = mean(`Distance_GC_(km)`),
    Trips = mean(Passenger_Trips)) %>%
  arrange(desc(Distance)) %>%
  head(n = 10) %>%
  ggplot(aes(x = Distance, y = Trips)) +
  geom_point(size = 3.0, color = "#990033") +
  geom_text_repel(
    aes(label = Journey), size=2.5, 
    colour = "#333333") +
  scale_x_continuous(
    breaks = seq(0, 5000, 500), 
    limits = c(0, 5000)) +
  scale_y_continuous(
    breaks = seq(0, 200000, 20000), 
    limits = c(0, 200000),
    labels = scales::comma) +
  labs(
    title = "Ten longest flights",
    subtitle = "Plotted against 2016 passenger trips",
    y = "Number of trips", 
    x = "Distance (km)") +
  theme_minimal()
```

## Chord diagram

Top n routes by passenger trips

```{r}
circos.par()
dom %>%
  busiest_routes(year = 2016, n = 20) %>%
  chordDiagram(
    annotationTrack = "grid",
    preAllocateTracks = list(track.height = max(strwidth(unlist(dimnames(.))))),
    link.border = "#666666")

circos.track(
  track.index = 1, 
  panel.fun = function(x, y) {
    circos.text(
      CELL_META$xcenter, CELL_META$ylim[1], CELL_META$sector.index, 
      facing = "clockwise", 
      niceFacing = TRUE, 
      adj = c(0, 0.5), 
      cex = 0.5)
  }, bg.border = NA) # here set bg.border to NA is important

circos.clear()
```

# Revenue by route

```{r}
rpk <- dom %>%
  by_airport_pairs %>%
  group_by(Journey) %>%
  summarise(
    mean_RPK = mean(RPKs)/1e6, 
    Distance = mean(`Distance_GC_(km)`)) %>%
  arrange(desc(mean_RPK)) %>%
  head(n = 15)

rpk %>%
  ggplot(aes(x = reorder(Journey, mean_RPK), y = mean_RPK)) +
  geom_col(width = 0.5, fill = "#6666ff") +
  geom_text(
    aes(label = round(mean_RPK, digits = 1)), 
    size=2.5, hjust = -0.1, 
    colour = "#333333") +
  scale_y_continuous(breaks = seq(0, 400, 50), limits = c(0, 400)) +
  coord_flip() +
  theme_minimal() +
  labs(title = "Revenue by route",
       x = NULL,
       y = "Revenue ($M)")
```

## Plot revenue against distance

```{r}
rpk %>%
  ggplot(aes(x = Distance, y = mean_RPK)) +
  geom_point(colour = "#990033", size = 3) +
  geom_text_repel(aes(label = Journey), size = 2.5) +
  scale_x_continuous(breaks = seq(0, 4000, 500), limits = c(0, 4000)) +
  scale_y_continuous(breaks = seq(0, 400, 50), limits = c(0, 400)) +
  labs(
    title = "Revenue vs Distance",
    x = "Distance (km)",
    y = "Revenue ($M)") +
  theme_minimal()
```

# Map

```{r}
library(ggmap)
library(memoise)
library(stringr)
```

## Get coordinates for all the cities


```{r, message = FALSE}
# Memoise the external API call.
geocode_f <- memoise(geocode)

get_coords <- function (df) {
  cities <- union(unique(dom$City1), unique(dom$City2)) %>% data_frame(City = .)
  
  cities %>%
    do(geocode_f(str_c(.$City, ", AUSTRALIA"))) %>%
    bind_cols(cities) %>%
    select(City, lon, lat)
}
coords <- get_coords(dom)
```

Add coordinates to the main data frame.

```{r}
dom_coords <- dom %>%
  left_join(coords, by = c("City1" = "City")) %>%
  left_join(coords, by = c("City2" = "City")) %>%
  rename(lon1 = lon.x, lat1 = lat.x, lon2 = lon.y, lat2 = lat.y)
```

## Plot busiest routes on the map

```{r}
basemap <- get_map(
  location = "Australia", 
  source = "google",
  zoom = 4, scale = 2,
  maptype = "terrain", 
  color = "bw")
```

```{r}
busiest <- dom_coords %>%
    filter(Year == 2016) %>%
    group_by(City1, City2, lon1, lat1, lon2, lat2) %>%
    summarise(
      Trips = floor(mean(Passenger_Trips))) %>%
    arrange(desc(Trips)) %>%
    head(n = 20) %>%
  by_airport_pairs

ggmap(basemap, base_layer = ggplot(busiest)) +
  geom_segment(
    aes(x = lon1, y = lat1, 
        xend = lon2, yend = lat2, size = Trips), 
    colour = "#990033", lineend = "round", show.legend = FALSE)
```

