---
title: "City Pairs - Domestic Traffic"
author: "AndrewJ"
date: "4 June 2016"
output: html_document
---

# Description

Visualisation experimentation on some random data sets. In this case, it's an [monthly airport domestic traffic data](https://data.gov.au/dataset/domestic-airlines-top-routes-and-totals) via data.gov.au, dated 2016-05.

# Setup

```{r, message=FALSE}
rm(list=ls())

library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggthemes)
library(treemap)
library(formattable)
library(circlize)
```

# Import and preparation

```{r, echo = FALSE}
read_traffic <- function () {
  read_csv("data/DOMCityPairsWeb.csv")
}
```

```{r}
transform_traffic <- function (df) {
  df %>% 
  mutate(
    Month = as.Date(Month, origin="1899-12-30"), # Convert from Excel format
    City1 = as.factor(City1),
    City2 = as.factor(City2))
}
```

# Analysis Functions

Aggregate traffic by months, and augment with moving averages using `zoo::rollmean`.

```{r}
monthly_traffic <- . %>%
  group_by(Month) %>%
  summarise(
    Trips = sum(Passenger_Trips),
    Seats = sum(Seats)) %>%
  mutate(
    Trips = rollmean(Trips, k = 12, fill = "extend", align = "center"),
    Seats = rollmean(Seats, k = 12, fill = "extend", align = "center"))
```

Help get stats on source and destination airport pairs by grouping into a single field.

```{r}
by_airport_pairs <- . %>%
  unite(Journey, City1, City2, sep = " â€” ", remove = TRUE) %>%
  group_by(Journey)
```

Busiest Routes

```{r}
busiest_routes <- . %>%
  by_airport_pairs() %>%
  filter(Year == 2015) %>%
  summarise(Trips = Passenger_Trips %>% mean %>% floor) %>%
  arrange(desc(Trips)) %>%
  head(n = 20)
```


# Run

## Import the data.

```{r}
dom <- read_traffic() %>% transform_traffic()
str(dom)
levels(dom$City1)
```

## Do some plotting with `ggplot2`.

### Time series moving average

Melt the data into a time series format with `gather`, and use `geom_line` to plot.

```{r}
dom %>%
  monthly_traffic() %>%
  gather(
    key = Type, value = Trips, 
    Trips, Seats) %>%
  ggplot(aes(x=Month, y=Trips, colour=Type)) +
    geom_line(stat = 'identity', position = "stack") +
    scale_y_continuous(labels = scales::comma) +
    labs(
      title = "Passenger Trips and Seats", 
      x = "Month", 
      y = "Number") +
    theme_fivethirtyeight()
```

Bar chart of the busiest routes last year

```{r}
dom %>%
  busiest_routes %>%
  ggplot(aes(x = reorder(Journey, Trips), y = Trips)) +
    geom_bar(stat = "identity", width = 0.8) +
    geom_text(
      aes(label = Trips), 
      size=3, hjust = -0.1, 
      colour = "black") +
    scale_y_continuous(
      limits = c(0, 800000),
      labels = scales::comma) +
    coord_flip() +
    labs(
      title = "Top Passenger Trips in 2015", 
      x = "Journey", 
      y = "Passengers") +
    theme(axis.title.y = element_blank())
```

Bar chart of the longest journeys

```{r}
dom %>%
  by_airport_pairs() %>%
  summarise(
    Distance = mean(`Distance_GC_(km)`),
    Trips = mean(Passenger_Trips)) %>%
  arrange(desc(Distance)) %>%
  head(n = 20) %>%
  ggplot(aes(x = reorder(Journey, Distance), y = Distance)) +
  geom_bar(stat = "identity", aes(fill = Trips)) +
  coord_flip() +
  labs(
    title = "Longest flights", 
    y = "Distance (km)", 
    x = "Sector")
```

Chord diagram for top 20 journeys.

```{r}
dom %>%
  group_by(City1, City2) %>%
  summarise(Trips = sum(Passenger_Trips)) %>%
  ungroup() %>%
  arrange(desc(Trips)) %>%
  head(20) %>%
  chordDiagram()
circos.clear()
```

Play with a scatter plot.

```{r}
dom %>%
  by_airport_pairs %>%
  summarise(
    Passengers = sum(Passenger_Trips), 
    Flights = sum(Aircraft_Trips),
    Load = mean(Passenger_Load_Factor),
    Distance = mean(`Distance_GC_(km)`)) %>%
  ggplot(aes(x = Passengers, y = Distance, colour = Load)) +
  geom_point() +
  labs(
    title = "Passengers by Distance",
    x = "Passengers",
    y = "Distance (km)")
```

## Plot with `rbokeh`.

```{r}
library(rbokeh)

dom %>% 
  busiest_routes() %>%
  figure(data = ., width = 500, height = 400) %>%
  ly_bar(Journey, Trips) %>%
  theme_axis("x", major_label_orientation = 45)
```

## Plot with `plot.ly`

```{r}
library(plotly)

dom %>%
  busiest_routes %>%
  plot_ly(
    type = 'bar', 
    x = rev(Trips),
    y = rev(reorder(Journey, Trips)),
    orientation = "h") %>%
  layout(
    title = "Top Passenger Trips in 2015",
    margin = list(l = 200),
    xaxis = list(title = "Number of trips", dtick = 50e3),
    yaxis = list(title = ""))
```

